<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Simule seus jogos nas loterias: Mega-Sena, Quina, Lotofácil, Dia de Sorte, Dupla Sena e Lotomania. Veja quantos acertos você teria nos últimos concursos!">
        <meta name="keywords" content="simulador loterias, mega-sena, quina, lotofácil, fechamento loterias">
        <!-- Estrutura de dados Schema.org -->
        <script type="application/ld+json">
        {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Simulador de Loterias - Sorte Analisada",
        "description": "Simule seus jogos nas principais loterias brasileiras"
        }
        </script>
        
        <title>Simulador de Loterias - Sorte Analisada</title>
        <link rel="icon" href="/static/images/logotipo.png" type="image/png">
        
        <!-- Fontes e Scripts Externos -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

        <link rel="stylesheet" href="static/css/styles.css">

        <style>
            /* Variáveis de Tema */
            :root {
                --cor-fundo: linear-gradient(180deg, #020f2c, #0d47a1, #1976d2);
                --cor-caixa: rgba(255, 255, 255, 0.08);
                --cor-texto: #E0E0E0;
                --cor-dourado: #FFD700;
                --cor-dourado-hover: #FFAA00;
                --cor-loteria-display: #81d4fa;
                --sombra-dourada: 0 0 12px rgba(255, 215, 0, 0.4);
                --sombra-caixa: 0 8px 25px rgba(0, 0, 0, 0.5);
                --cor-divisoria-ouro: rgba(255, 215, 0, 0.3);
                --cor-sucesso: #4CAF50;
                --cor-erro: #f44336;
                --cor-aviso: #ff9800;
            }

            /* Reset e Base */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                scroll-behavior: smooth;
            }

            body {
                font-family: 'Poppins', sans-serif;
                background: var(--cor-fundo);
                color: var(--cor-texto);
                margin: 0;
                padding: 20px 0;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
            }

            .container {
                background: var(--cor-caixa);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                box-shadow: var(--sombra-caixa);
                padding: 2rem;
                max-width: 1000px;
                width: 95%;
                text-align: center;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            /* Tipografia */
            h1, h2, h3, h4 {
                font-family: 'Orbitron', sans-serif;
            }

            h1 {
                font-size: 2.2rem;
                color: var(--cor-dourado);
                text-transform: uppercase;
                letter-spacing: 1.5px;
                margin-bottom: 0.5rem;
            }

            .subtitulo {
                font-size: 1.6rem;
                font-weight: 400;
                margin-bottom: 0;
                color: #bbdefb;
            }

            /* Navegação */
            .nav-interna {
                padding: 1.5rem 0;
                margin: 1rem 0;
                border-top: 1px solid var(--cor-divisoria-ouro);
                border-bottom: 1px solid var(--cor-divisoria-ouro);
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }

            .nav-interna a {
                color: var(--cor-dourado);
                text-decoration: none;
                font-size: 1.1rem;
                font-weight: 500;
                transition: color 0.2s;
            }

            .nav-interna a:hover {
                color: var(--cor-dourado-hover);
            }

            /* Imagens */
            .imagem-ouro {
                background-color: #FFF8E1;
                padding: 8px;
                border-radius: 10px;
                width: 150px;
                height: auto;
                border: 3px solid var(--cor-dourado);
                box-shadow: var(--sombra-dourada);
                transition: transform 0.3s ease;
            }

            /* Botões */
            .botao-gerar, .botao-simular, .botao-gerar-fechamento {
                background: linear-gradient(145deg, var(--cor-dourado), var(--cor-dourado-hover));
                color: #000;
                border: none;
                padding: 0.8rem 1.5rem;
                font-size: 1.1rem;
                font-weight: 700;
                border-radius: 40px;
                cursor: pointer;
                transition: all 0.3s ease-in-out;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 10px;
                margin: 0.5rem;
            }

            .botao-gerar:hover:not(:disabled),
            .botao-simular:hover:not(:disabled),
            .botao-gerar-fechamento:hover:not(:disabled) {
                transform: translateY(-3px);
                box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
            }

            .botao-gerar:disabled,
            .botao-simular:disabled,
            .botao-gerar-fechamento:disabled {
                cursor: not-allowed;
                opacity: 0.6;
                transform: none;
            }

            /* Controles */
            .secao-controles {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 1.5rem;
                flex-wrap: wrap;
                margin: 2.5rem 0;
            }

            .controle-item {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .seletor-custom {
                background-color: rgba(0, 0, 0, 0.3);
                color: var(--cor-dourado);
                padding: 8px 12px;
                border: 1px solid var(--cor-dourado);
                border-radius: 8px;
                font-size: 1.1rem;
                cursor: pointer;
            }

            /* Seletor de Números */
            .numero-grid {
                display: grid;
                grid-template-columns: repeat(10, 1fr);
                gap: 8px;
                margin: 2rem 0;
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
            }

            .numero-botao {
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid rgba(255, 255, 255, 0.3);
                color: var(--cor-texto);
                padding: 10px 5px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                font-size: 1rem;
                transition: all 0.2s ease;
                min-height: 45px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .numero-botao:hover {
                background: rgba(255, 255, 255, 0.2);
                border-color: var(--cor-dourado);
            }

            .numero-botao.selecionado {
                background: var(--cor-dourado);
                border-color: var(--cor-dourado);
                color: #000;
                box-shadow: var(--sombra-dourada);
            }

            .numero-botao:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }

            /* Contador */
            .contador-dezenas {
                font-size: 1.3rem;
                font-weight: bold;
                color: var(--cor-dourado);
                margin: 1rem 0;
                padding: 0.8rem;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 8px;
                border-left: 4px solid var(--cor-dourado);
            }

            /* Resultados da Simulação */
            .resultado-simulacao {
                margin-top: 2rem;
                padding: 1.5rem;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 12px;
                border-left: 4px solid var(--cor-sucesso);
            }

            .tabela-resultados {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                overflow: hidden;
            }

            .tabela-resultados th,
            .tabela-resultados td {
                padding: 12px;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .tabela-resultados th {
                background: rgba(0, 0, 0, 0.3);
                color: var(--cor-dourado);
                font-weight: bold;
            }

            .tabela-resultados tr:nth-child(even) {
                background: rgba(255, 255, 255, 0.02);
            }

            /* Resumo da Simulação */
            .resumo-simulacao {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin: 2rem 0;
            }

            .card-resumo {
                background: rgba(0, 0, 0, 0.2);
                padding: 1.5rem;
                border-radius: 12px;
                border-top: 4px solid var(--cor-dourado);
                text-align: center;
            }

            .card-resumo h4 {
                color: var(--cor-dourado);
                margin-bottom: 0.5rem;
                font-size: 1.1rem;
            }

            .card-resumo .numero-destaque {
                font-size: 2rem;
                font-weight: bold;
                color: var(--cor-sucesso);
                display: block;
                margin: 0.5rem 0;
            }

            /* Seções */
            .secao {
                margin: 3rem 0;
                padding: 2rem 0;
                border-top: 1px solid var(--cor-divisoria-ouro);
            }

            .secao:first-of-type {
                border-top: none;
            }

            .secao h2 {
                color: var(--cor-dourado);
                font-size: 1.8rem;
                margin-bottom: 1.5rem;
            }

            /* Sistema de Fechamento */
            .fechamento-resultado {
                margin-top: 2rem;
                padding: 1.5rem;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 12px;
                border-left: 4px solid var(--cor-dourado);
            }

            .jogo-fechamento {
                background: rgba(255, 255, 255, 0.05);
                padding: 1rem;
                margin: 0.5rem 0;
                border-radius: 8px;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap;
                gap: 5px;
            }

            .numero-jogo {
                font-size: 1.2rem;
                font-weight: bold;
                color: var(--cor-dourado);
                padding: 0.3rem 0.6rem;
                background: rgba(255, 215, 0, 0.1);
                border-radius: 4px;
                margin: 2px;
            }

            /* Loading */
            .loading {
                display: none;
                justify-content: center;
                align-items: center;
                padding: 2rem;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid rgba(255, 215, 0, 0.3);
                border-left: 4px solid var(--cor-dourado);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Responsivo */
            @media (max-width: 768px) {
                .numero-grid {
                    grid-template-columns: repeat(8, 1fr);
                    gap: 6px;
                }
                
                .numero-botao {
                    padding: 8px 4px;
                    font-size: 0.9rem;
                    min-height: 40px;
                }
                
                .container {
                    padding: 1.5rem;
                }
                
                h1 {
                    font-size: 1.8rem;
                }
                
                .resumo-simulacao {
                    grid-template-columns: 1fr;
                }
            }

            @media (max-width: 480px) {
                .numero-grid {
                    grid-template-columns: repeat(6, 1fr);
                    gap: 4px;
                }
                
                .numero-botao {
                    padding: 6px 3px;
                    font-size: 0.8rem;
                    min-height: 35px;
                }
                
                .secao-controles {
                    flex-direction: column;
                    gap: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <img src="/static/images/logotipo.webp" alt="Logotipo Sorte Analisada" class="imagem-ouro" width="128" height="131">
                <h1>Simulador Sorte Analisada</h1>
                <p class="subtitulo">Teste seus palpites com base nos resultados históricos!</p>
            </header>

            <nav class="nav-interna">
                <a href="/">Sorte Analisada</a>
                <a href="#simulador">Simulador</a>
                <a href="#fechamento">Fechamento</a>
                <a href="/blog">Blog</a>
            </nav>

            <!-- Seção Simulador -->
            <section id="simulador" class="secao">
                <h2>Simulador de Loterias</h2>
                <p>Selecione sua loteria, escolha seus números e descubra quantos acertos você teria nos resultados anteriores!</p>

                <div class="secao-controles">
                    <div class="controle-item">
                        <label for="loteria-simulador">Loteria:</label>
                        <select id="loteria-simulador" class="seletor-custom">
                            <option value="megasena">Mega-Sena</option>
                            <option value="quina">Quina</option>
                            <option value="lotofacil">Lotofácil</option>
                            <option value="diadesorte">Dia de Sorte</option>
                            <option value="duplasena">Dupla Sena</option>
                            <option value="lotomania">Lotomania</option>
                        </select>
                    </div>
                </div>

                <div class="contador-dezenas" id="contador-simulador">
                    Selecione seus números: 0 de 6 escolhidos
                </div>

                <div id="grid-numeros-simulador" class="numero-grid">
                    <!-- Números serão gerados dinamicamente -->
                </div>

                <div style="margin: 2rem 0;">
                    <button id="btn-simular" class="botao-simular" disabled>
                        <i class="fas fa-play"></i>
                        Simular em Todos os Concursos
                    </button>
                    <button id="btn-limpar-simulador" class="botao-gerar">
                        <i class="fas fa-eraser"></i>
                        Limpar Seleção
                    </button>
                </div>

                <div class="loading" id="loading-simulador">
                    <div class="spinner"></div>
                </div>

                <div id="resultado-simulacao" style="display: none;"></div>
            </section>

            <!-- Seção Sistema de Fechamento -->
            <section id="fechamento" class="secao">
                <h2>Fechamento de Loterias</h2>
                <p>Selecione seus números favoritos e nosso sistema gerará até 20 jogos otimizados para cobrir suas escolhas!</p>

                <div class="secao-controles">
                    <div class="controle-item">
                        <label for="loteria-fechamento">Loteria:</label>
                        <select id="loteria-fechamento" class="seletor-custom">
                            <option value="megasena">Mega-Sena</option>
                            <option value="quina">Quina</option>
                            <option value="lotofacil">Lotofácil</option>
                            <option value="diadesorte">Dia de Sorte</option>
                            <option value="duplasena">Dupla Sena</option>
                        </select>
                    </div>
                </div>

                <div class="contador-dezenas" id="contador-fechamento">
                    Selecione seus números favoritos: 0 escolhidos
                </div>

                <div id="grid-numeros-fechamento" class="numero-grid">
                    <!-- Números serão gerados dinamicamente -->
                </div>

                <div style="margin: 2rem 0;">
                    <button id="btn-gerar-fechamento" class="botao-gerar-fechamento" disabled>
                        <i class="fas fa-magic"></i>
                        Gerar Fechamento (até 20 jogos)
                    </button>
                    <button id="btn-limpar-fechamento" class="botao-gerar">
                        <i class="fas fa-eraser"></i>
                        Limpar Seleção
                    </button>
                </div>

                <div class="loading" id="loading-fechamento">
                    <div class="spinner"></div>
                </div>

                <div id="resultado-fechamento" style="display: none;"></div>
            </section>

            <!-- footer esta na pasta statics/partials -->
            <div id="footer"></div>
            
        </div>

        <script>
            // Configurações das loterias
            const LOTTERY_CONFIG = {
                'megasena': { min_num: 1, max_num: 60, num_bolas_sorteadas: 6, min_dezenas: 6, max_dezenas: 15 },
                'quina': { min_num: 1, max_num: 80, num_bolas_sorteadas: 5, min_dezenas: 5, max_dezenas: 15 },
                'lotofacil': { min_num: 1, max_num: 25, num_bolas_sorteadas: 15, min_dezenas: 15, max_dezenas: 18 },
                'diadesorte': { min_num: 1, max_num: 31, num_bolas_sorteadas: 7, min_dezenas: 7, max_dezenas: 15 },
                'duplasena': { min_num: 1, max_num: 50, num_bolas_sorteadas: 6, min_dezenas: 6, max_dezenas: 15 },
                'lotomania': { min_num: 1, max_num: 100, num_bolas_sorteadas: 20, min_dezenas: 50, max_dezenas: 50 }
            };

            // Estado da aplicação
            let numerosSelecionadosSimulador = new Set();
            let numerosSelecionadosFechamento = new Set();
            let loteriaAtualSimulador = 'megasena';
            let loteriaAtualFechamento = 'megasena';

            // Inicialização
            document.addEventListener('DOMContentLoaded', function() {
                inicializarSimulador();
                inicializarFechamento();
                adicionarEventListeners();
            });

            function inicializarSimulador() {
                const loteria = document.getElementById('loteria-simulador').value;
                loteriaAtualSimulador = loteria;
                gerarGridNumeros('simulador', loteria);
                atualizarContador('simulador');
            }

            function inicializarFechamento() {
                const loteria = document.getElementById('loteria-fechamento').value;
                loteriaAtualFechamento = loteria;
                gerarGridNumeros('fechamento', loteria);
                atualizarContador('fechamento');
            }

            function adicionarEventListeners() {
                // Simulador
                document.getElementById('loteria-simulador').addEventListener('change', function() {
                    numerosSelecionadosSimulador.clear();
                    inicializarSimulador();
                });

                document.getElementById('btn-simular').addEventListener('click', executarSimulacao);
                document.getElementById('btn-limpar-simulador').addEventListener('click', function() {
                    limparSelecao('simulador');
                });

                // Fechamento
                document.getElementById('loteria-fechamento').addEventListener('change', function() {
                    numerosSelecionadosFechamento.clear();
                    inicializarFechamento();
                });

                document.getElementById('btn-gerar-fechamento').addEventListener('click', gerarFechamento);
                document.getElementById('btn-limpar-fechamento').addEventListener('click', function() {
                    limparSelecao('fechamento');
                });
            }

            function gerarGridNumeros(tipo, loteria) {
                const config = LOTTERY_CONFIG[loteria];
                const grid = document.getElementById(`grid-numeros-${tipo}`);
                const numeros = tipo === 'simulador' ? numerosSelecionadosSimulador : numerosSelecionadosFechamento;
                
                grid.innerHTML = '';

                for (let i = config.min_num; i <= config.max_num; i++) {
                    const button = document.createElement('button');
                    button.className = 'numero-botao';
                    button.textContent = String(i).padStart(2, '0');
                    button.dataset.numero = i;
                    
                    if (numeros.has(i)) {
                        button.classList.add('selecionado');
                    }

                    button.addEventListener('click', function() {
                        toggleNumero(tipo, i);
                    });

                    grid.appendChild(button);
                }
            }

            function toggleNumero(tipo, numero) {
                const numeros = tipo === 'simulador' ? numerosSelecionadosSimulador : numerosSelecionadosFechamento;
                const loteria = tipo === 'simulador' ? loteriaAtualSimulador : loteriaAtualFechamento;
                const config = LOTTERY_CONFIG[loteria];
                const button = document.querySelector(`#grid-numeros-${tipo} [data-numero="${numero}"]`);

                if (numeros.has(numero)) {
                    numeros.delete(numero);
                    button.classList.remove('selecionado');
                } else {
                    // Para o simulador, limitar ao número exato de dezenas
                    if (tipo === 'simulador' && numeros.size >= config.num_bolas_sorteadas) {
                        return;
                    }
                    // Para fechamento, permitir mais números
                    if (tipo === 'fechamento' && numeros.size >= config.max_dezenas) {
                        return;
                    }
                    numeros.add(numero);
                    button.classList.add('selecionado');
                }

                atualizarContador(tipo);
                atualizarBotoes(tipo);
            }

            function atualizarContador(tipo) {
                const numeros = tipo === 'simulador' ? numerosSelecionadosSimulador : numerosSelecionadosFechamento;
                const loteria = tipo === 'simulador' ? loteriaAtualSimulador : loteriaAtualFechamento;
                const config = LOTTERY_CONFIG[loteria];
                const contador = document.getElementById(`contador-${tipo}`);

                if (tipo === 'simulador') {
                    contador.textContent = `Selecione seus números: ${numeros.size} de ${config.num_bolas_sorteadas} escolhidos`;
                } else {
                    const min = config.num_bolas_sorteadas + 1;
                    contador.textContent = `Selecione seus números favoritos: ${numeros.size} escolhidos (mínimo ${min} para fechamento)`;
                }
            }

            function atualizarBotoes(tipo) {
                const numeros = tipo === 'simulador' ? numerosSelecionadosSimulador : numerosSelecionadosFechamento;
                const loteria = tipo === 'simulador' ? loteriaAtualSimulador : loteriaAtualFechamento;
                const config = LOTTERY_CONFIG[loteria];
                const botao = document.getElementById(tipo === 'simulador' ? 'btn-simular' : 'btn-gerar-fechamento');

                if (tipo === 'simulador') {
                    botao.disabled = numeros.size !== config.num_bolas_sorteadas;
                } else {
                    botao.disabled = numeros.size <= config.num_bolas_sorteadas;
                }
            }

            function limparSelecao(tipo) {
                const numeros = tipo === 'simulador' ? numerosSelecionadosSimulador : numerosSelecionadosFechamento;
                const loteria = tipo === 'simulador' ? loteriaAtualSimulador : loteriaAtualFechamento;
                
                numeros.clear();
                gerarGridNumeros(tipo, loteria);
                atualizarContador(tipo);
                atualizarBotoes(tipo);
                
                // Esconder resultados
                document.getElementById(`resultado-${tipo}`).style.display = 'none';
            }

            async function executarSimulacao() {
                const loading = document.getElementById('loading-simulador');
                const resultado = document.getElementById('resultado-simulacao');
                
                loading.style.display = 'flex';
                resultado.style.display = 'none';

                try {
                    // Buscar TODOS os resultados (sem limite de 20)
                    const response = await fetch(`/get-todos-resultados?loteria=${loteriaAtualSimulador}`);
                    const resultados = await response.json();

                    if (resultados.error) {
                        throw new Error(resultados.error);
                    }

                    // Executar simulação com todos os concursos
                    const numerosEscolhidos = Array.from(numerosSelecionadosSimulador);
                    const simulacao = simularJogos(numerosEscolhidos, resultados, loteriaAtualSimulador);
                    
                    exibirResultadoSimulacao(simulacao, numerosEscolhidos, resultados);
                    
                } catch (error) {
                    console.error('Erro na simulação:', error);
                    resultado.innerHTML = `
                        <div class="resultado-simulacao" style="border-left-color: var(--cor-erro);">
                            <h3 style="color: var(--cor-erro);">Erro na Simulação</h3>
                            <p>Não foi possível executar a simulação. Tente novamente.</p>
                        </div>
                    `;
                    resultado.style.display = 'block';
                } finally {
                    loading.style.display = 'none';
                }
            }

                        function simularJogos(numerosEscolhidos, resultados, loteria) { // Adicione 'loteria' como parâmetro
                const acertosPorConcurso = [];
                let totalAcertosGeral = 0; // Somatório de acertos para a média
                let melhorAcertoGeral = 0; // Melhor acerto em qualquer concurso/sorteio
                const distribuicaoAcertos = {}; // Para a tabela de distribuição

                resultados.forEach(concurso => {
                    let acertosNoConcurso = 0;
                    let numerosAcertadosNoConcurso = [];
                    let numerosSorteadosDisplay = concurso.dezenas; // Para exibir no TOP 10

                    if (loteria === 'duplasena') {
                        // Para Dupla Sena, as dezenas são 12 (6 do 1º sorteio, 6 do 2º)
                        const dezenasPrimeiroSorteio = concurso.dezenas.split(' ').slice(0, 6).map(n => parseInt(n));
                        const dezenasSegundoSorteio = concurso.dezenas.split(' ').slice(6, 12).map(n => parseInt(n));

                        const acertos1Sorteio = numerosEscolhidos.filter(n => dezenasPrimeiroSorteio.includes(n));
                        const acertos2Sorteio = numerosEscolhidos.filter(n => dezenasSegundoSorteio.includes(n));

                        // Considera o melhor acerto entre os dois sorteios para o resultado individual do concurso
                        if (acertos1Sorteio.length >= acertos2Sorteio.length) {
                            acertosNoConcurso = acertos1Sorteio.length;
                            numerosAcertadosNoConcurso = acertos1Sorteio;
                            numerosSorteadosDisplay = dezenasPrimeiroSorteio.map(n => String(n).padStart(2, '0')).join(' ');
                        } else {
                            acertosNoConcurso = acertos2Sorteio.length;
                            numerosAcertadosNoConcurso = acertos2Sorteio;
                            numerosSorteadosDisplay = dezenasSegundoSorteio.map(n => String(n).padStart(2, '0')).join(' ');
                        }

                    } else {
                        const numerossorteados = concurso.dezenas.split(' ').map(n => parseInt(n));
                        numerosAcertadosNoConcurso = numerosEscolhidos.filter(n => numerossorteados.includes(n));
                        acertosNoConcurso = numerosAcertadosNoConcurso.length;
                    }
                    
                    acertosPorConcurso.push({
                        concurso: concurso.concurso,
                        data: concurso.data,
                        numerossorteados: numerosSorteadosDisplay, // Pode ser o 1º sorteio para Dupla Sena
                        acertos: acertosNoConcurso,
                        numerosAcertados: numerosAcertadosNoConcurso.map(n => String(n).padStart(2, '0')).join(', ')
                    });

                    totalAcertosGeral += acertosNoConcurso;
                    melhorAcertoGeral = Math.max(melhorAcertoGeral, acertosNoConcurso);
                    distribuicaoAcertos[acertosNoConcurso] = (distribuicaoAcertos[acertosNoConcurso] || 0) + 1;
                });

                // Ordenar acertosPorConcurso do maior para o menor antes de retornar
                acertosPorConcurso.sort((a, b) => b.acertos - a.acertos);

                return {
                    acertos: acertosPorConcurso,
                    totalAcertos: totalAcertosGeral,
                    melhorAcerto: melhorAcertoGeral,
                    mediaAcertos: (totalAcertosGeral / resultados.length).toFixed(2),
                    distribuicaoAcertos,
                    totalConcursos: resultados.length
                };
            }

            function exibirResultadoSimulacao(simulacao, numerosEscolhidos, resultados) {
                const resultado = document.getElementById('resultado-simulacao');
                
                // Ordenar por maior número de acertos e pegar os 10 primeiros
                const maioresAcertos = simulacao.acertos
                    .sort((a, b) => b.acertos - a.acertos)
                    .slice(0, 10);
                
                let html = `
                    <div class="resultado-simulacao">
                        <h3><i class="fas fa-chart-line"></i> Resultado da Simulação</h3>
                        <p><strong>Seus números:</strong> ${numerosEscolhidos.map(n => String(n).padStart(2, '0')).join(', ')}</p>
                        
                        <div class="resumo-simulacao">
                            <div class="card-resumo">
                                <h4>Total de Acertos</h4>
                                <span class="numero-destaque">${simulacao.totalAcertos}</span>
                                <p>em ${simulacao.totalConcursos} concursos</p>
                            </div>
                            <div class="card-resumo">
                                <h4>Melhor Resultado</h4>
                                <span class="numero-destaque">${simulacao.melhorAcerto}</span>
                                <p>acertos em um concurso</p>
                            </div>
                            <div class="card-resumo">
                                <h4>Média de Acertos</h4>
                                <span class="numero-destaque">${simulacao.mediaAcertos}</span>
                                <p>por concurso</p>
                            </div>
                        </div>

                        <h4 style="color: var(--cor-dourado); margin-top: 2rem;">Distribuição de Acertos</h4>
                        <table class="tabela-resultados">
                            <thead>
                                <tr>
                                    <th>Acertos</th>
                                    <th>Frequência</th>
                                    <th>Porcentagem</th>
                                </tr>
                            </thead>
                            <tbody>`;

                const maxAcertos = Math.max(...Object.keys(simulacao.distribuicaoAcertos).map(k => parseInt(k)));
                for (let i = maxAcertos; i >= 0; i--) {
                    const freq = simulacao.distribuicaoAcertos[i] || 0;
                    const perc = ((freq / simulacao.totalConcursos) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td>${i}</td>
                            <td>${freq}</td>
                            <td>${perc}%</td>
                        </tr>`;
                }

                html += `
                            </tbody>
                        </table>

                        <h4 style="color: var(--cor-dourado); margin-top: 2rem;">Top 10 Maiores Acertos</h4>
                        <table class="tabela-resultados">
                            <thead>
                                <tr>
                                    <th>Posição</th>
                                    <th>Concurso</th>
                                    <th>Data</th>
                                    <th>Números Sorteados</th>
                                    <th>Acertos</th>
                                    <th>Números Acertados</th>
                                </tr>
                            </thead>
                            <tbody>`;

                maioresAcertos.forEach((item, index) => {
                    const corLinha = item.acertos >= 4 ? 'style="background-color: rgba(76, 175, 80, 0.2);"' : 
                                item.acertos >= 3 ? 'style="background-color: rgba(255, 193, 7, 0.2);"' : '';
                    html += `
                        <tr ${corLinha}>
                            <td><strong>${index + 1}º</strong></td>
                            <td>${item.concurso}</td>
                            <td>${item.data}</td>
                            <td>${item.numerossorteados}</td>
                            <td><strong>${item.acertos}</strong></td>
                            <td>${item.numerosAcertados || '-'}</td>
                        </tr>`;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                resultado.innerHTML = html;
                resultado.style.display = 'block';
            }

            async function gerarFechamento() {
                const loading = document.getElementById('loading-fechamento');
                const resultado = document.getElementById('resultado-fechamento');
                
                loading.style.display = 'flex';
                resultado.style.display = 'none';

                try {
                    const numerosEscolhidos = Array.from(numerosSelecionadosFechamento);
                    const config = LOTTERY_CONFIG[loteriaAtualFechamento];
                    
                    // Gerar jogos de fechamento
                    const jogos = gerarJogosFechamento(numerosEscolhidos, config);
                    
                    exibirResultadoFechamento(jogos, numerosEscolhidos);
                    
                } catch (error) {
                    console.error('Erro no fechamento:', error);
                    resultado.innerHTML = `
                        <div class="fechamento-resultado" style="border-left-color: var(--cor-erro);">
                            <h3 style="color: var(--cor-erro);">Erro no Fechamento</h3>
                            <p>Não foi possível gerar o fechamento. Tente novamente.</p>
                        </div>
                    `;
                    resultado.style.display = 'block';
                } finally {
                    loading.style.display = 'none';
                }
            }

                        function gerarJogosFechamento(numerosEscolhidos, config) {
                const jogos = [];
                const maxJogos = 20;
                const numerosPorJogo = config.num_bolas_sorteadas;
                
                if (numerosEscolhidos.length < numerosPorJogo) {
                    console.warn("Número de dezenas escolhidas é menor que o necessário para um jogo. Não é possível gerar fechamento.");
                    return [];
                }

                // Se o número de dezenas escolhidas for igual ao número de bolas por jogo, o jogo é único
                if (numerosEscolhidos.length === numerosPorJogo) {
                    return [numerosEscolhidos.sort((a, b) => a - b)];
                }

                const jogosSet = new Set(); // Para evitar jogos duplicados

                // Estratégia: Tentar formar jogos garantindo que os números apareçam de forma equilibrada,
                // e combinando aleatoriamente para gerar diversidade.
                let tentativasGeracao = 0;
                const MAX_TENTATIVAS_INTERNAS = 1000; // Limite de tentativas para cada jogo

                while (jogos.length < maxJogos && tentativasGeracao < MAX_TENTATIVAS_INTERNAS * 2) {
                    tentativasGeracao++;
                    let jogoCandidato = [];
                    let numerosRestantesParaEscolher = [...numerosEscolhidos];

                    // Tentar pegar os números de forma a "espalhar" a escolha
                    // Misturar os números restantes para evitar padrões
                    for (let i = numerosRestantesParaEscolher.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [numerosRestantesParaEscolher[i], numerosRestantesParaEscolher[j]] = [numerosRestantesParaEscolher[j], numerosRestantesParaEscolher[i]];
                    }

                    // Preencher o jogo com números únicos do pool selecionado
                    while (jogoCandidato.length < numerosPorJogo && numerosRestantesParaEscolher.length > 0) {
                        jogoCandidato.push(numerosRestantesParaEscolher.shift());
                    }
                    
                    // Ordenar o jogo para padronização e evitar duplicatas por ordem
                    jogoCandidato.sort((a, b) => a - b);
                    const jogoString = jogoCandidato.join(',');

                    // Adicionar se não for duplicado e tiver o tamanho correto
                    if (!jogosSet.has(jogoString) && jogoCandidato.length === numerosPorJogo) {
                        jogosSet.add(jogoString);
                        jogos.push(jogoCandidato);
                    }
                }
                
                // Se ainda não atingiu maxJogos, podemos tentar gerar mais algumas combinações simples
                // Esta parte é mais para garantir que tenhamos a quantidade máxima se possível,
                // mesmo que a "inteligência" inicial não tenha sido suficiente.
                while (jogos.length < maxJogos && tentativasGeracao < MAX_TENTATIVAS_INTERNAS * 5) { // Aumenta as tentativas gerais
                    tentativasGeracao++;
                    let tempNumeros = [...numerosEscolhidos];
                    let jogoCandidato = [];

                    // Shuffle e slice para pegar uma combinação aleatória
                    for (let i = tempNumeros.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [tempNumeros[i], tempNumeros[j]] = [tempNumeros[j], tempNumeros[i]];
                    }
                    jogoCandidato = tempNumeros.slice(0, numerosPorJogo);
                    jogoCandidato.sort((a, b) => a - b);
                    const jogoString = jogoCandidato.join(',');

                    if (!jogosSet.has(jogoString) && jogoCandidato.length === numerosPorJogo) {
                        jogosSet.add(jogoString);
                        jogos.push(jogoCandidato);
                    }
                }

                return jogos;
            }

            function exibirResultadoFechamento(jogos, numerosEscolhidos) {
                const resultado = document.getElementById('resultado-fechamento');
                
                let html = `
                    <div class="fechamento-resultado">
                        <h3><i class="fas fa-magic"></i> Sistema de Fechamento</h3>
                        <p><strong>Seus números escolhidos:</strong> ${numerosEscolhidos.map(n => String(n).padStart(2, '0')).join(', ')}</p>
                        <p><strong>Jogos gerados:</strong> ${jogos.length}</p>
                        
                        <div style="margin-top: 2rem;">
                `;

                jogos.forEach((jogo, index) => {
                    html += `
                        <div class="jogo-fechamento">
                            <strong>Jogo ${index + 1}:</strong>
                            ${jogo.map(n => `<span class="numero-jogo">${String(n).padStart(2, '0')}</span>`).join('')}
                        </div>
                    `;
                });

                html += `
                        </div>
                        
                        <div style="margin-top: 2rem; padding: 1rem; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid var(--cor-aviso);">
                            <h4 style="color: var(--cor-aviso); margin-bottom: 0.5rem;">💡 Dica Importante</h4>
                            <p style="margin: 0; font-size: 1rem;">
                                Este é um fechamento básico que distribui seus números escolhidos entre os jogos gerados. 
                                Para um fechamento matemático mais avançado, considere usar ferramentas especializadas.
                            </p>
                        </div>
                    </div>
                `;
                

                resultado.innerHTML = html;
                resultado.style.display = 'block';
            }
                
            // Inicializar quando a página carregar
            window.addEventListener('load', function() {
                inicializarSimulador();
                inicializarFechamento();
            });

           
            // Carregar footer se não estiver sendo carregado automaticamente
            fetch('/static/partials/footer.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('footer').innerHTML = html;
                })
                .catch(err => console.log('Footer não encontrado'));
    

        </script>
    </body>
</html>