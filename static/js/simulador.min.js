const LOTTERY_CONFIG={megasena:{min_num:1,max_num:60,num_bolas_sorteadas:6,min_dezenas:6,max_dezenas:15},quina:{min_num:1,max_num:80,num_bolas_sorteadas:5,min_dezenas:5,max_dezenas:15},lotofacil:{min_num:1,max_num:25,num_bolas_sorteadas:15,min_dezenas:15,max_dezenas:18},diadesorte:{min_num:1,max_num:31,num_bolas_sorteadas:7,min_dezenas:7,max_dezenas:15},duplasena:{min_num:1,max_num:50,num_bolas_sorteadas:6,min_dezenas:6,max_dezenas:15},lotomania:{min_num:1,max_num:100,num_bolas_sorteadas:20,min_dezenas:50,max_dezenas:50}};let numerosSelecionadosSimulador=new Set,numerosSelecionadosFechamento=new Set,loteriaAtualSimulador="megasena",loteriaAtualFechamento="megasena";function inicializarSimulador(){let e=document.getElementById("loteria-simulador").value;loteriaAtualSimulador=e,gerarGridNumeros("simulador",e),atualizarContador("simulador")}function inicializarFechamento(){let e=document.getElementById("loteria-fechamento").value;loteriaAtualFechamento=e,gerarGridNumeros("fechamento",e),atualizarContador("fechamento")}function adicionarEventListeners(){document.getElementById("loteria-simulador").addEventListener("change",function(){numerosSelecionadosSimulador.clear(),inicializarSimulador()}),document.getElementById("btn-simular").addEventListener("click",executarSimulacao),document.getElementById("btn-limpar-simulador").addEventListener("click",function(){limparSelecao("simulador")}),document.getElementById("loteria-fechamento").addEventListener("change",function(){numerosSelecionadosFechamento.clear(),inicializarFechamento()}),document.getElementById("btn-gerar-fechamento").addEventListener("click",gerarFechamento),document.getElementById("btn-limpar-fechamento").addEventListener("click",function(){limparSelecao("fechamento")})}function gerarGridNumeros(e,a){let o=LOTTERY_CONFIG[a],t=document.getElementById(`grid-numeros-${e}`),r="simulador"===e?numerosSelecionadosSimulador:numerosSelecionadosFechamento;t.innerHTML="";for(let s=o.min_num;s<=o.max_num;s++){let n=document.createElement("button");n.className="numero-botao",n.textContent=String(s).padStart(2,"0"),n.dataset.numero=s,r.has(s)&&n.classList.add("selecionado"),n.addEventListener("click",function(){toggleNumero(e,s)}),t.appendChild(n)}}function toggleNumero(e,a){let o="simulador"===e?numerosSelecionadosSimulador:numerosSelecionadosFechamento,t="simulador"===e?loteriaAtualSimulador:loteriaAtualFechamento,r=LOTTERY_CONFIG[t],s=document.querySelector(`#grid-numeros-${e} [data-numero="${a}"]`);if(o.has(a))o.delete(a),s.classList.remove("selecionado");else{if("simulador"===e&&o.size>=r.num_bolas_sorteadas||"fechamento"===e&&o.size>=r.max_dezenas)return;o.add(a),s.classList.add("selecionado")}atualizarContador(e),atualizarBotoes(e)}function atualizarContador(e){let a="simulador"===e?numerosSelecionadosSimulador:numerosSelecionadosFechamento,o="simulador"===e?loteriaAtualSimulador:loteriaAtualFechamento,t=LOTTERY_CONFIG[o],r=document.getElementById(`contador-${e}`);if("simulador"===e)r.textContent=`Selecione seus n\xfameros: ${a.size} de ${t.num_bolas_sorteadas} escolhidos`;else{let s=t.num_bolas_sorteadas+1;r.textContent=`Selecione seus n\xfameros favoritos: ${a.size} escolhidos (m\xednimo ${s} para fechamento)`}}function atualizarBotoes(e){let a="simulador"===e?numerosSelecionadosSimulador:numerosSelecionadosFechamento,o="simulador"===e?loteriaAtualSimulador:loteriaAtualFechamento,t=LOTTERY_CONFIG[o],r=document.getElementById("simulador"===e?"btn-simular":"btn-gerar-fechamento");"simulador"===e?r.disabled=a.size!==t.num_bolas_sorteadas:r.disabled=a.size<=t.num_bolas_sorteadas}function limparSelecao(e){let a="simulador"===e?loteriaAtualSimulador:loteriaAtualFechamento;("simulador"===e?numerosSelecionadosSimulador:numerosSelecionadosFechamento).clear(),gerarGridNumeros(e,a),atualizarContador(e),atualizarBotoes(e),"simulador"===e?document.getElementById("resultado-simulacao").style.display="none":document.getElementById("resultado-fechamento").style.display="none"}async function executarSimulacao(){let e=document.getElementById("loading-simulador"),a=document.getElementById("resultado-simulacao");e.style.display="flex",a.style.display="none";try{let o=await fetch(`/get-todos-resultados?loteria=${loteriaAtualSimulador}`),t=await o.json();if(t.error)throw Error(t.error);let r=Array.from(numerosSelecionadosSimulador),s=simularJogos(r,t,loteriaAtualSimulador);exibirResultadoSimulacao(s,r,t)}catch(n){console.error("Erro na simula\xe7\xe3o:",n),a.innerHTML=`
                <div class="resultado-simulacao" style="border-left-color: var(--cor-erro);">
                    <h3 style="color: var(--cor-erro);">Erro na Simula\xe7\xe3o</h3>
                    <p>N\xe3o foi poss\xedvel executar a simula\xe7\xe3o. Tente novamente.</p>
                </div>
            `,a.style.display="block"}finally{e.style.display="none"}}function simularJogos(e,a,o){let t=[],r=0,s=0,n={};return a.forEach(a=>{let l=0,i=[],d=a.dezenas;if("duplasena"===o){let m=a.dezenas.split(" ").slice(0,6).map(e=>parseInt(e)),c=a.dezenas.split(" ").slice(6,12).map(e=>parseInt(e)),u=e.filter(e=>m.includes(e)),h=e.filter(e=>c.includes(e));u.length>=h.length?(l=u.length,i=u,d=m.map(e=>String(e).padStart(2,"0")).join(" ")):(l=h.length,i=h,d=c.map(e=>String(e).padStart(2,"0")).join(" "))}else{let g=a.dezenas.split(" ").map(e=>parseInt(e));l=(i=e.filter(e=>g.includes(e))).length}t.push({concurso:a.concurso,data:a.data,numerossorteados:d,acertos:l,numerosAcertados:i.map(e=>String(e).padStart(2,"0")).join(", ")}),r+=l,s=Math.max(s,l),n[l]=(n[l]||0)+1}),t.sort((e,a)=>a.acertos-e.acertos),{acertos:t,totalAcertos:r,melhorAcerto:s,mediaAcertos:(r/a.length).toFixed(2),distribuicaoAcertos:n,totalConcursos:a.length}}function exibirResultadoSimulacao(e,a,o){let t=document.getElementById("resultado-simulacao"),r=e.acertos.sort((e,a)=>a.acertos-e.acertos).slice(0,5),s=`
            <div class="resultado-simulacao">
                <h3><i class="fas fa-chart-line"></i> Resultado da Simula\xe7\xe3o</h3>
                <p><strong>Seus n\xfameros:</strong> ${a.map(e=>String(e).padStart(2,"0")).join(", ")}</p>
                
                <div class="resumo-simulacao">
                    <div class="card-resumo">
                        <h4>Total de Acertos</h4>
                        <span class="numero-destaque">${e.totalAcertos}</span>
                        <p>em ${e.totalConcursos} concursos</p>
                    </div>
                    <div class="card-resumo">
                        <h4>Melhor Resultado</h4>
                        <span class="numero-destaque">${e.melhorAcerto}</span>
                        <p>acertos em um concurso</p>
                    </div>
                    <div class="card-resumo">
                        <h4>M\xe9dia de Acertos</h4>
                        <span class="numero-destaque">${e.mediaAcertos}</span>
                        <p>por concurso</p>
                    </div>
                </div>

                <h4 style="color: var(--cor-dourado); margin-top: 2rem;">Distribui\xe7\xe3o de Acertos</h4>
                <table class="tabela-resultados">
                    <thead>
                        <tr>
                            <th>Acertos</th>
                            <th>Frequ\xeancia</th>
                            <th>Porcentagem</th>
                        </tr>
                    </thead>
                    <tbody>`,n=Math.max(...Object.keys(e.distribuicaoAcertos).map(e=>parseInt(e)));for(let l=n;l>=0;l--){let i=e.distribuicaoAcertos[l]||0,d=(i/e.totalConcursos*100).toFixed(1);s+=`
                <tr>
                    <td>${l}</td>
                    <td>${i}</td>
                    <td>${d}%</td>
                </tr>`}s+=`
                        </tbody>
                    </table>

                    <h4 style="color: var(--cor-dourado); margin-top: 2rem;">Top 5 Maiores Acertos</h4>
                    <table class="tabela-resultados">
                        <thead>
                            <tr>
                                <th>Posi\xe7\xe3o</th>
                                <th>Concurso</th>
                                <th>Data</th>
                                <th>N\xfameros Sorteados</th>
                                <th>Acertos</th>
                                <th>N\xfameros Acertados</th>
                            </tr>
                        </thead>
                        <tbody>`,r.forEach((e,a)=>{let o=e.acertos>=4?'style="background-color: rgba(76, 175, 80, 0.2);"':e.acertos>=3?'style="background-color: rgba(255, 193, 7, 0.2);"':"";s+=`
                    <tr ${o}>
                        <td><strong>${a+1}\xba</strong></td>
                        <td>${e.concurso}</td>
                        <td>${e.data}</td>
                        <td>${e.numerossorteados}</td>
                        <td><strong>${e.acertos}</strong></td>
                        <td>${e.numerosAcertados||"-"}</td>
                    </tr>`}),s+=`
                        </tbody>
                    </table>
                </div>
            `,t.innerHTML=s,t.style.display="block"}async function gerarFechamento(){let e=document.getElementById("loading-fechamento"),a=document.getElementById("resultado-fechamento");e.style.display="flex",a.style.display="none";try{let o=Array.from(numerosSelecionadosFechamento),t=LOTTERY_CONFIG[loteriaAtualFechamento],r=gerarJogosFechamento(o,t);exibirResultadoFechamento(r,o)}catch(s){console.error("Erro no fechamento:",s),a.innerHTML=`
                <div class="fechamento-resultado" style="border-left-color: var(--cor-erro);">
                    <h3 style="color: var(--cor-erro);">Erro no Fechamento</h3>
                    <p>N\xe3o foi poss\xedvel gerar o fechamento. Tente novamente.</p>
                </div>
            `,a.style.display="block"}finally{e.style.display="none"}}function gerarJogosFechamento(e,a){let o=[],t=a.num_bolas_sorteadas;if(e.length<t)return console.warn("N\xfamero de dezenas escolhidas \xe9 menor que o necess\xe1rio para um jogo."),[];if(e.length===t)return[e.sort((e,a)=>e-a)];let r={};e.forEach(e=>r[e]=0);let s=new Set,n=[...e];for(;n.length>=t&&o.length<10;){n.sort((e,a)=>r[e]-r[a]);let l=n.slice(0,t).sort((e,a)=>e-a),i=l.join(",");if(s.has(i))break;s.add(i),o.push(l),l.forEach(e=>r[e]++),n.shift()}let d=0;for(;o.length<10&&d<1e3;){d++;let m=[...e].sort((e,a)=>r[e]-r[a]),c=m.slice(0,Math.ceil(m.length/2)),u=m.slice(Math.ceil(m.length/2)),h=Math.floor(t/2),g=[],f=[...c].sort(()=>Math.random()-.5);g.push(...f.slice(0,h)),g.length;let p=[...u].sort(()=>Math.random()-.5);for(let y=0;y<p.length&&g.length<t;y++)g.includes(p[y])||g.push(p[y]);if(g.length<t){for(let S of e)if(!g.includes(S)&&(g.push(S),g.length===t))break}g.sort((e,a)=>e-a);let b=g.join(",");s.has(b)||g.length!==t||(s.add(b),o.push(g),g.forEach(e=>r[e]++))}for(d=0;o.length<10&&d<1e3;){d++;let v=[...e].sort(()=>Math.random()-.5),$=v.slice(0,t).sort((e,a)=>e-a),E=$.join(",");s.has(E)||(s.add(E),o.push($),$.forEach(e=>r[e]++))}return o}function exibirResultadoFechamento(e,a){let o=document.getElementById("resultado-fechamento"),t=`
            <div class="fechamento-resultado">
                <h3><i class="fas fa-magic"></i> Sistema de Organiza\xe7\xe3o</h3>
                <p><strong>Seus n\xfameros escolhidos:</strong> ${a.map(e=>String(e).padStart(2,"0")).join(", ")}</p>
                <p><strong>Jogos gerados:</strong> ${e.length}</p>
                
                <div style="margin-top: 2rem;">
        `;e.forEach((e,a)=>{t+=`
                <div class="jogo-fechamento">
                    <strong>Jogo ${a+1}:</strong>
                    ${e.map(e=>`<span class="numero-jogo">${String(e).padStart(2,"0")}</span>`).join("")}
                </div>
            `}),t+=`
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid var(--cor-aviso);">
                    <h4 style="color: var(--cor-aviso); margin-bottom: 0.5rem;">ðŸ’¡ Dica Importante</h4>
                    <p style="margin: 0; font-size: 1rem;">
                        Este \xe9 um organizador que distribui seus n\xfameros escolhidos entre os jogos gerados e gera 10 jogos. 
                        Para um fechamento matem\xe1tico mais avan\xe7ado, considere usar ferramentas especializadas.
                    </p>
                </div>
            </div>
        `,o.innerHTML=t,o.style.display="block"}document.addEventListener("DOMContentLoaded",function(){inicializarSimulador(),inicializarFechamento(),adicionarEventListeners()}),window.addEventListener("load",function(){inicializarSimulador(),inicializarFechamento()}),fetch("/static/partials/footer.html").then(e=>e.text()).then(e=>{document.getElementById("footer").innerHTML=e}).catch(e=>console.log("Footer n\xe3o encontrado"));