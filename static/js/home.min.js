let loteriaAtual="megasena",carregandoUltimosGeral=!1;const lotteryConfig={maismilionaria:{nome:"+Milion\xe1ria",min_dezenas:6,max_dezenas:12,num_bolas:6,universo:50,default_dezenas:6,num_trevos:2,universo_trevos:6},megasena:{nome:"Mega-Sena",min_dezenas:6,max_dezenas:20,num_bolas:6,universo:60,default_dezenas:6},quina:{nome:"Quina",min_dezenas:5,max_dezenas:15,num_bolas:5,universo:80,default_dezenas:5},lotofacil:{nome:"Lotof\xe1cil",min_dezenas:15,max_dezenas:20,num_bolas:15,universo:25,default_dezenas:15},diadesorte:{nome:"Dia de Sorte",min_dezenas:7,max_dezenas:15,num_bolas:7,universo:31,default_dezenas:7},duplasena:{nome:"Dupla Sena",min_dezenas:6,max_dezenas:15,num_bolas:6,universo:50,default_dezenas:6},lotomania:{nome:"Lotomania",min_dezenas:50,max_dezenas:50,num_bolas:20,universo:100,default_dezenas:50},timemania:{nome:"Timemania",min_dezenas:10,max_dezenas:10,num_bolas:7,universo:80,default_dezenas:10},supersete:{nome:"Super Sete",min_dezenas:7,max_dezenas:7,num_bolas:7,universo:9,default_dezenas:7}},cooldownTimes={montecarlo:10};function mudarLoteria(e){loteriaAtual=e;let a=lotteryConfig[loteriaAtual],t=getElement("loteria-selecionada");t&&(t.textContent=a.nome,t.style.opacity=1);let r=getElement("loteria-select-resultados");r&&(r.value=e);let o=getElement("nome-loteria-resultados");o&&(o.textContent=a.nome),atualizarOpcoesDezenas(),atualizarOpcoesQuantidade(),handleEstrategiaChange(),limparResultadosAnteriores(),carregarUltimosResultados(e)}function mudarLoteriaResultados(e){let a=lotteryConfig[e],t=getElement("nome-loteria-resultados");t&&(t.textContent=a.nome),carregarUltimosResultados(e)}function limparResultadosAnteriores(){let e=getElement("area-resultados");e&&(e.innerHTML="");let a=getElement("area-estatisticas");a&&(a.style.display="none");let t=document.querySelector("#estatisticas .botao-gerar");t&&(t.style.display="block",t.disabled=!1,t.innerHTML="Estat\xedsticas")}function atualizarOpcoesDezenas(){let e=getElement("dezenas-select");if(!e)return;let a=lotteryConfig[loteriaAtual];e.innerHTML="";for(let t=a.min_dezenas;t<=a.max_dezenas;t++){let r=document.createElement("option");r.value=t,r.textContent=`${t} Dezenas`,e.appendChild(r)}}function atualizarOpcoesQuantidade(){let e=getElement("quantidade-select");if(e){e.innerHTML="";for(let a=1;a<=10;a++){let t=document.createElement("option");t.value=a,t.textContent=`${String(a).padStart(2,"0")} ${a>1?"Jogos":"Jogo"}`,e.appendChild(t)}}}function handleEstrategiaChange(){let e={estrategia:getElement("estrategia-select"),dezenas:getElement("dezenas-select"),quantidade:getElement("quantidade-select"),ancora:getElement("numeros-ancora")};if(!e.estrategia)return;let a=e.estrategia.value,t=lotteryConfig[loteriaAtual],r="montecarlo"===a;r&&(e.dezenas.value=t.num_bolas,e.quantidade.value=1,e.ancora.value=""),Object.values(e).slice(1).forEach(e=>{e.disabled=r})}async function gerarPalpites(){if(isRequestInProgress)return;let e={resultados:getElement("area-resultados"),estrategia:getElement("estrategia-select"),dezenas:getElement("dezenas-select"),quantidade:getElement("quantidade-select"),ancora:getElement("numeros-ancora")};if(!e.resultados||!e.estrategia)return;let a={estrategia:e.estrategia.value,dezenas:e.dezenas.value,quantidade:e.quantidade.value,ancora:e.ancora.value};setGeradorEstado(!0),e.resultados.innerHTML='<div class="spinner"></div>';try{let t=construirURL(a),r=await fetch(t);if(!r.ok)throw Error(`Erro na comunica\xe7\xe3o: ${r.statusText}`);let o=await r.json();if(o.error)throw Error(`Erro no servidor: ${o.error}`);let s="montecarlo"===a.estrategia?[o.jogo]:o;renderizarJogos(s,e.resultados)}catch(n){console.error("Erro ao gerar palpites:",n),e.resultados.innerHTML=`<p style="color: #ff8a80;">Falha na conex\xe3o. Tente novamente em alguns segundos.</p>`}finally{aplicarCooldown(a.estrategia)}}function construirURL(e){let{estrategia:a,quantidade:t,dezenas:r,ancora:o}=e;return"montecarlo"===a?`/get-monte-carlo-game?loteria=${loteriaAtual}&ancora=${o}`:`/get-games/${t}?loteria=${loteriaAtual}&estrategia=${a}&dezenas=${r}&ancora=${o}`}function aplicarCooldown(e){let a=cooldownTimes[e];if(!a){setGeradorEstado(!1),handleEstrategiaChange();return}let t=getElement("botao-gerar-principal");if(!t)return;let r=a;t.innerHTML=`Aguarde ${r}s...`;let o=setInterval(()=>{--r>0?t.innerHTML=`Aguarde ${r}s...`:(clearInterval(o),t.innerHTML="Gerar Palpites",setGeradorEstado(!1),handleEstrategiaChange())},1e3)}function renderizarJogos(e,a){a&&(a.innerHTML="<h2>Boa sorte!</h2>",e.forEach(e=>{let t=criarElementoJogo(e);a.appendChild(t)}))}function criarElementoJogo(e){let a=document.createElement("div");a.className="jogo";let t=document.createElement("div");t.className="numeros-container";let r=e.trim().split(/\s+/);if("duplasena"===loteriaAtual&&12===r.length){let o=r.slice(0,6),s=r.slice(6,12),n=document.createElement("div");n.className="sorteio-header",n.textContent="1\xba Sorteio:",t.appendChild(n),o.forEach(e=>{let a=document.createElement("span");a.className="numero",a.textContent=e,t.appendChild(a)});let i=document.createElement("div");i.className="sorteio-header",i.textContent="2\xba Sorteio:",t.appendChild(i),s.forEach(e=>{let a=document.createElement("span");a.className="numero",a.textContent=e,t.appendChild(a)})}else{let l=[...r].sort((e,a)=>e-a);l.forEach(e=>{let a=document.createElement("span");a.className="numero",a.textContent=e,t.appendChild(a)})}return"diadesorte"===loteriaAtual&&t.appendChild(criarMesSorte()),a.appendChild(t),a.appendChild(criarBotaoCopiar()),a}function criarMesSorte(){let e=meses[Math.floor(Math.random()*meses.length)],a=document.createElement("span");return a.textContent=`| M\xeas: ${e}`,a.style.cssText="font-weight:bold; margin-left:15px; font-size: 1.2rem;",a}function criarBotaoCopiar(){let e=document.createElement("button");return e.className="botao-copiar",e.innerHTML='<i class="fa-regular fa-copy"></i>',e.title="Copiar n\xfameros",e.onclick=()=>copiarNumeros(e),e}async function exibirEstatisticas(){let e=document.querySelector("#estatisticas .botao-gerar");if(!isRequestInProgress&&e&&!e.disabled){await loadChartJS(),isRequestInProgress=!0,e.disabled=!0,e.innerHTML='<div class="spinner" style="width: 25px; height: 25px; margin: 0 auto;"></div> Carregando...';try{let a=await buscarDadosEstatisticas();atualizarInfoEstatisticas(a.gerais),criarTodosGraficos(a);let t=getElement("area-estatisticas");t&&(t.style.display="block"),e.style.display="none"}catch(r){console.error("Erro ao carregar estat\xedsticas:",r),mostrarErroEstatisticas(r.message),e.innerHTML="Estat\xedsticas",e.disabled=!1}finally{isRequestInProgress=!1}}}async function buscarDadosEstatisticas(){try{let[e,a]=await Promise.all([fetch(`/get-stats?loteria=${loteriaAtual}`),fetch(`/get-stats-recentes?loteria=${loteriaAtual}`)]);if(!e.ok)throw Error(`Erro ${e.status}: ${e.statusText}`);if(!a.ok)throw Error(`Erro ${a.status}: ${a.statusText}`);let t=await e.json(),r=await a.json();if(t.error)throw Error(`Backend: ${t.error}`);if(r.error)throw Error(`Backend: ${r.error}`);if(!t.frequencia||!Array.isArray(t.frequencia))throw Error("Dados de frequ\xeancia inv\xe1lidos recebidos do servidor.");if(!r.frequencia_recente||!Array.isArray(r.frequencia_recente))throw Error("Dados de frequ\xeancia recente inv\xe1lidos recebidos do servidor.");return{gerais:t,recentes:r}}catch(o){throw console.error("Erro detalhado ao buscar estat\xedsticas:",o),Error(`Falha na comunica\xe7\xe3o com o servidor: ${o.message}`)}}function atualizarInfoEstatisticas(e){let a=lotteryConfig[loteriaAtual].nome,t=getElement("ultimo-concurso-info");t&&(t.innerHTML=`An\xe1lise da ${a}: at\xe9 o concurso ${e.ultimo_concurso}`)}function criarTodosGraficos(e){Object.values(graficos).forEach(e=>{e&&e.destroy()});let a={scales:{y:{ticks:{color:"#FFFDE7"},grid:{color:"rgba(255, 255, 255, 0.2)"}},x:{ticks:{color:"#FFFDE7"},grid:{color:"transparent"}}},plugins:{legend:{labels:{color:"#FFFDE7"},onClick:null}}};graficos.maisSorteados=criarGrafico("grafico-mais-sorteados",e.gerais.frequencia,"desc","Vezes Sorteado","#FFD700",a),graficos.menosSorteados=criarGrafico("grafico-menos-sorteados",e.gerais.frequencia,"asc","Vezes Sorteado","#90CAF9",a),graficos.maisSorteadosRecentes=criarGrafico("grafico-mais-sorteados-recentes",e.recentes.frequencia_recente,"desc","Vezes Sorteado (\xdaltimos 100)","#FFECB3",a),graficos.menosSorteadosRecentes=criarGrafico("grafico-menos-sorteados-recentes",e.recentes.frequencia_recente,"asc","Vezes Sorteado (\xdaltimos 100)","#BBDEFB",a),graficos.primos=criarGraficoPrimos(e.gerais.stats_primos,a),graficos.paresImpares=criarGraficoParesImpares(e.gerais.stats_pares,a)}function criarGrafico(e,a,t,r,o,s){let n=getElement(e);if(!n)return null;let i=[...a].sort((e,a)=>"desc"===t?a.frequencia-e.frequencia:e.frequencia-a.frequencia).slice(0,10);return new Chart(n.getContext("2d"),{type:"bar",data:{labels:i.map(e=>`N\xba ${e.numero}`),datasets:[{label:r,data:i.map(e=>e.frequencia),backgroundColor:o}]},options:s})}function criarGraficoPrimos(e,a){let t=getElement("grafico-primos");if(!t)return null;let r=Object.keys(e).sort((e,a)=>parseInt(e)-parseInt(a)).map(e=>`${e} Primos`),o=Object.keys(e).sort((e,a)=>parseInt(e)-parseInt(a)).map(a=>e[a]);return new Chart(t.getContext("2d"),{type:"bar",data:{labels:r,datasets:[{label:"Sorteios",data:o,backgroundColor:"#81C784"}]},options:a})}function criarGraficoParesImpares(e,a){let t=getElement("grafico-pares-impares");if(!t)return null;let r=lotteryConfig[loteriaAtual].num_bolas,o=Object.keys(e).sort((e,a)=>parseInt(e)-parseInt(a)).map(e=>`${e} Pares / ${r-parseInt(e)} \xcdmpares`),s=Object.keys(e).sort((e,a)=>parseInt(e)-parseInt(a)).map(a=>e[a]);return new Chart(t.getContext("2d"),{type:"bar",data:{labels:o,datasets:[{label:"Sorteios",data:s,backgroundColor:"#FF8A65"}]},options:a})}function mostrarErroEstatisticas(e){let a=getElement("area-estatisticas");a&&(a.innerHTML=`<p style="color: #ff8a80;">${e}</p>`,a.style.display="block")}async function carregarUltimosResultados(e){if(carregandoResultados)return;carregandoResultados=!0;let a=getElement("lista-ultimos-resultados");if(!a){carregandoResultados=!1;return}a.innerHTML='<div class="spinner"></div>';try{let t=await fetch(`/get-ultimos-resultados?loteria=${e}`);if(!t.ok)throw Error("Falha ao carregar os resultados.");let r=await t.json();if(r.error)throw Error(r.error);if(0===r.length){a.innerHTML="<p>Nenhum resultado encontrado para esta loteria.</p>";return}a.innerHTML=r.map(a=>criarHtmlResultado(a,e)).join("")}catch(o){console.error("Erro ao carregar \xfaltimos resultados:",o),a.innerHTML=`<p style="color: #ff8a80;">N\xe3o foi poss\xedvel carregar os resultados. Tente novamente mais tarde.</p>`}finally{carregandoResultados=!1}}async function carregarUltimosResultadosGeral(){if(carregandoUltimosGeral)return;carregandoUltimosGeral=!0;let e=getElement("ultimos-resultados-geral"),a=getElement("spinner-ultimos-geral");if(!e||!a){carregandoUltimosGeral=!1;return}a.style.display="block";let t="";try{let r=["maismilionaria","megasena","quina","lotofacil","diadesorte","duplasena","lotomania","timemania","supersete"].map(async e=>{let a=lotteryConfig[e],t=await fetch(`/get-ultimos-resultados?loteria=${e}&limite=1`);if(!t.ok)return console.error(`Falha ao carregar o \xfaltimo resultado da ${a.nome}.`),"";let r=await t.json();if(r.error||0===r.length)return console.warn(`Nenhum resultado encontrado para a ${a.nome} ou erro: ${r.error}`),"";let o=r[0];return`
                <div class="ultimo-resultado-card">
                    <h4 class="nome-loteria-card">${a.nome}</h4>
                    ${criarHtmlResultado(o,e)}
                </div>
            `}),o=await Promise.all(r);(t=o.join(""))?e.innerHTML=`
                <h3 style="color: var(--cor-dourado); text-align: center; margin-bottom: 1rem;">Resultados das Loterias</h3>
                <div class="resultados-geral-grid">
                    ${t}
                </div>
            `:e.innerHTML=`
                <h3 style="color: var(--cor-dourado); text-align: center; margin-bottom: 1rem;">Resultados das Loterias</h3>
                <p style="text-align: center; color: #ff8a80;">N\xe3o foi poss\xedvel carregar os \xfaltimos resultados de algumas loterias.</p>
            `}catch(s){console.error("Erro ao carregar \xfaltimos resultados gerais:",s),e.innerHTML=`
            <h3 style="color: var(--cor-dourado); text-align: center; margin-bottom: 1rem;">Loterias</h3>
            <p style="text-align: center; color: #ff8a80;">Erro ao carregar os resultados. Tente novamente mais tarde.</p>
        `}finally{a.style.display="none",carregandoUltimosGeral=!1}}function criarHtmlResultado(e,a){let t=criarStatusHtml(e),r=criarMesHtml(e,a),o=formatarData(e.data),s=`<div class="resultado-dezenas">${e.dezenas}</div>`;if("maismilionaria"===a&&e.dezenas&&e.trevos){let n=e.dezenas.split(" "),i=e.trevos.split(" "),l=n.map(e=>String(e).padStart(2,"0")).join(" ");s=`
            <div class="resultado-dezenas">${l}</div>
            <div style="margin-top: 0.5rem; font-size: 1.1rem;">
                <span style="color: var(--cor-texto);">Trevos: </span>
                <span style="color: var(--cor-dourado); font-weight: 700;">${i.join(" ")}</span>
            </div>
        `}else if("duplasena"===a&&e.dezenas){let d=e.dezenas.split(" ");if(12===d.length){let c=d.slice(0,6),u=d.slice(6,12);s=`
                <div class="duplasena-sorteios">
                    <div class="sorteio-header">1\xba Sorteio:</div>
                    <div class="resultado-dezenas">${c.join(" ")}</div>
                    <div class="sorteio-header">2\xba Sorteio:</div>
                    <div class="resultado-dezenas">${u.join(" ")}</div>
                </div>
            `}else s=`<div class="resultado-dezenas">${e.dezenas}</div>`}else if("timemania"===a&&e.dezenas&&e.time_coracao){let m=e.dezenas.split(" "),f=m.map(e=>String(e).padStart(2,"0")).join(" ");s=`
            <div class="resultado-dezenas">${f}</div>
            <div style="margin-top: 0.5rem; font-size: 1.1rem;">
                <span style="color: var(--cor-texto);">Time do Cora\xe7\xe3o: </span>
                <span style="color: var(--cor-dourado); font-weight: 700;">${e.time_coracao}</span>
            </div>
        `}else if("supersete"===a&&e.dezenas){let p=e.dezenas.split("");s=`
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 10px 0;">
                ${p.map((e,a)=>`
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                        <span style="font-size: 0.9rem; color: var(--cor-dourado); opacity: 0.8;">${a+1}</span>
                        <span style="font-size: 1.7rem; font-weight: 700; color: var(--cor-dourado);">${e}</span>
                    </div>
                `).join("")}
            </div>
        `}else{let g=e.dezenas?e.dezenas.split(" "):[],v=g.map(e=>String(e).padStart(2,"0")).join(" ");s=`<div class="resultado-dezenas">${v}</div>`}return`
        <div class="resultado-item">
            <div class="resultado-header">
                <span class="resultado-concurso">Concurso ${e.concurso}</span>
                <span class="resultado-data">${o}</span>
            </div>
            ${s}
            ${r}
            <div class="resultado-status">${t}</div>
        </div>
    `}function criarStatusHtml(e){let a="";if(e.acumulou)a+='<span class="status-acumulou">ACUMULOU</span>';else{let t=e.ganhadores>1?"Ganhadores":"Ganhador";a+=`<span class="status-ganhador">${e.ganhadores} ${t}</span>`}if(e.valor_acumulado){let r=e.valor_acumulado.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});a+=`<div class="valor-acumulado">Acumulada pr\xf3ximo concurso: R$ ${r}</div>`}return a}function criarMesHtml(e,a){return"diadesorte"===a&&e.mes_sorte?`<div class="resultado-mes">M\xeas da Sorte: <strong>${e.mes_sorte}</strong></div>`:""}function formatarData(e){if(!e)return"";try{let[a,t,r]=e.split("/").map(Number);if(a&&t&&r&&!isNaN(new Date(r,t-1,a))){let o=new Date(r,t-1,a);return`${String(o.getDate()).padStart(2,"0")}/${String(o.getMonth()+1).padStart(2,"0")}/${o.getFullYear()}`}}catch(s){console.warn("Erro ao formatar data, tentando formato alternativo:",e,s)}return e}function configurarEventListenersHome(){console.log("Configurando event listeners da home...");let e=getElement("loteria-select");if(e){console.log("Encontrado loteria-select");let a=getElement("loteria-select-resultados");a&&a.addEventListener("change",function(){mudarLoteriaResultados(this.value)});let t=getElement("estrategia-select");t&&t.addEventListener("change",handleEstrategiaChange);let r=getElement("botao-gerar-principal");r&&r.addEventListener("click",gerarPalpites);let o=document.querySelector("#estatisticas .botao-gerar");o&&o.addEventListener("click",function(){exibirEstatisticas()})}else console.log("loteria-select n\xe3o encontrado")}document.addEventListener("DOMContentLoaded",function(){console.log("Home.js carregado - Inicializando..."),mudarLoteria("megasena"),configurarEventListenersHome(),carregarUltimosResultadosGeral()});